{"ID":"20240311125155-ntio071","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f527","id":"20240311125155-ntio071","tags":"C++20","title":"协程","updated":"20240311125304"},"Children":[{"ID":"20240311125211-nv5al9e","Type":"NodeParagraph","Properties":{"id":"20240311125211-nv5al9e","updated":"20240311125304"},"Children":[{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240309023136-v95wg3z","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"C++"},{"Type":"NodeText","Data":"20 开始引入协程，带有 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 任意关键字的函数称为协程函数,通常配合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"future"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generator"},{"Type":"NodeText","Data":"​ 标准库使用。"}]},{"ID":"20240311125211-7il49xt","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-7il49xt","updated":"20240311125211"},"Children":[{"ID":"20240311125211-x5fp6ov","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-x5fp6ov","updated":"20240311125211"},"Children":[{"ID":"20240311125211-p0k61zn","Type":"NodeParagraph","Properties":{"id":"20240311125211-p0k61zn","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"main"},{"Type":"NodeText","Data":"​ 函数，构造函数，析构函数，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"consteval"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"constexpr"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-hoyol4i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-hoyol4i","updated":"20240311125211"},"Children":[{"ID":"20240311125211-26rt08c","Type":"NodeParagraph","Properties":{"id":"20240311125211-26rt08c","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"return"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-y4g8505","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-y4g8505","updated":"20240311125211"},"Children":[{"ID":"20240311125211-kxiie0l","Type":"NodeParagraph","Properties":{"id":"20240311125211-kxiie0l","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"协程函数不能使用变长参数"}]}]}]},{"ID":"20240311125211-43joueo","Type":"NodeParagraph","Properties":{"id":"20240311125211-43joueo","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125232"},"Children":[{"Type":"NodeText","Data":"注意：协程由于不需要操作系统参与调度，可以节省切换线程的开销。但协程不一定比线程快，协程程序根本上还是单线程，在做 IO 相关或类似的需要 CPU 等待的任务时有优势，但在做 CPU 运算密集型程序时，多线程通常比协程优势更大，此时线程切换开销相比硬件上的并行运算节省的时间可以忽略。"}]},{"ID":"20240311125211-7yeio2f","Type":"NodeParagraph","Properties":{"id":"20240311125211-7yeio2f","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"有关协程的三个关键字："}]},{"ID":"20240311125211-uuhfeq5","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-uuhfeq5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-zy3ds8i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-zy3ds8i","updated":"20240311125211"},"Children":[{"ID":"20240311125211-iafpkxu","Type":"NodeParagraph","Properties":{"id":"20240311125211-iafpkxu","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 触发一个挂起点。开始执行任务，后接一个等待器（任务）。"}]}]},{"ID":"20240311125211-4on4b5l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-4on4b5l","updated":"20240311125211"},"Children":[{"ID":"20240311125211-cw4swfc","Type":"NodeParagraph","Properties":{"id":"20240311125211-cw4swfc","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 触发一个挂起点。方法执行完成"}]}]},{"ID":"20240311125211-htiijly","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-htiijly","updated":"20240311125211"},"Children":[{"ID":"20240311125211-gly0msn","Type":"NodeParagraph","Properties":{"id":"20240311125211-gly0msn","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 触发一个挂起点。暂停执行并返回一个值\n设普通函数 A 调用了协程函数 B，B 中 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 触发一个耗时任务并返回 A，等待任务完成后重新回到 B；"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 表示 B 执行完成，设置返回值后回到 A。"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​ 表示 B 产生了一个新的值并返回 A，但 B 还未完全完成。"}]}]}]},{"ID":"20240311125211-lxuosl0","Type":"NodeParagraph","Properties":{"id":"20240311125211-lxuosl0","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125241"},"Children":[{"Type":"NodeText","Data":"就 C++20 来说，标准库中还未有现成的用于返回的类型，需要自定义"}]},{"ID":"20240311125211-yznwn6t","Type":"NodeParagraph","Properties":{"id":"20240311125211-yznwn6t","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await"},{"Type":"NodeText","Data":"​ 后接一个等待器（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter"},{"Type":"NodeText","Data":"​），要求存在以下成员："}]},{"ID":"20240311125211-dnokjtu","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-dnokjtu","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mqmtnwt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mqmtnwt","updated":"20240311125211"},"Children":[{"ID":"20240311125211-m6l81r6","Type":"NodeParagraph","Properties":{"id":"20240311125211-m6l81r6","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bool await_ready()"},{"Type":"NodeText","Data":"​：当该函数返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"true"},{"Type":"NodeText","Data":"​ 时，表示数据已经准备好，无需继续等待"}]}]},{"ID":"20240311125211-i4v0zf0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-i4v0zf0","updated":"20240311125211"},"Children":[{"ID":"20240311125211-1ha16lw","Type":"NodeParagraph","Properties":{"id":"20240311125211-1ha16lw","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void await_suspend(std::coroutine_handle\u0026lt;\u0026gt; h)"},{"Type":"NodeText","Data":"​：当数据未准备好时，执行此函数"}]},{"ID":"20240311125211-57acn21","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-57acn21","updated":"20240311125211"},"Children":[{"ID":"20240311125211-fuudjtw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-fuudjtw","updated":"20240311125211"},"Children":[{"ID":"20240311125211-s3g559e","Type":"NodeParagraph","Properties":{"id":"20240311125211-s3g559e","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::coroutine_handle"},{"Type":"NodeText","Data":"​：协程句柄，可用于控制协程流程，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"operator()"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resume()"},{"Type":"NodeText","Data":"​ 函数可以用于恢复协程"}]}]},{"ID":"20240311125211-e6gjtw5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-e6gjtw5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-ewnzg9w","Type":"NodeParagraph","Properties":{"id":"20240311125211-ewnzg9w","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"允许返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bool"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"coroutine_handle"},{"Type":"NodeText","Data":"​ 类型"}]},{"ID":"20240311125211-48vhbnf","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-48vhbnf","updated":"20240311125211"},"Children":[{"ID":"20240311125211-iankmgn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-iankmgn","updated":"20240311125211"},"Children":[{"ID":"20240311125211-fmup3c4","Type":"NodeParagraph","Properties":{"id":"20240311125211-fmup3c4","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"true"},{"Type":"NodeText","Data":"​：将执行权交给调用者，协程保持挂起"}]}]},{"ID":"20240311125211-b74akob","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-b74akob","updated":"20240311125211"},"Children":[{"ID":"20240311125211-tyjsh7f","Type":"NodeParagraph","Properties":{"id":"20240311125211-tyjsh7f","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"false"},{"Type":"NodeText","Data":"​：恢复当前协程运行"}]}]},{"ID":"20240311125211-o77m71d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-o77m71d","updated":"20240311125211"},"Children":[{"ID":"20240311125211-xt4oeqx","Type":"NodeParagraph","Properties":{"id":"20240311125211-xt4oeqx","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"coroutine_handle"},{"Type":"NodeText","Data":"​：恢复 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"handle"},{"Type":"NodeText","Data":"​ 对应的协程"}]}]}]}]}]}]},{"ID":"20240311125211-xj86sja","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-xj86sja","updated":"20240311125211"},"Children":[{"ID":"20240311125211-i2ud3ca","Type":"NodeParagraph","Properties":{"id":"20240311125211-i2ud3ca","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"T await_resume()"},{"Type":"NodeText","Data":"​：返回协程执行结果，该结果称为可等待体"}]}]}]},{"ID":"20240311125211-eg88ccm","Type":"NodeParagraph","Properties":{"id":"20240311125211-eg88ccm","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_yield"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 要求函数返回类型是一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::coroutine_trait\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​ 的一个子类，并有一个嵌套类型 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"promise_type"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240311125211-y3vx1l5","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-y3vx1l5","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mzab9vh","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mzab9vh","updated":"20240311125211"},"Children":[{"ID":"20240311125211-unqzll5","Type":"NodeParagraph","Properties":{"id":"20240311125211-unqzll5","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"promise_type"},{"Type":"NodeText","Data":"​：用于存放数据的类型"}]},{"ID":"20240311125211-71iznda","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-71iznda","updated":"20240311125211"},"Children":[{"ID":"20240311125211-hg43msa","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-hg43msa","updated":"20240311125211"},"Children":[{"ID":"20240311125211-wgt8kqg","Type":"NodeParagraph","Properties":{"id":"20240311125211-wgt8kqg","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"T get_return_object()"},{"Type":"NodeText","Data":"​：设协程函数 B 在 A 中调用，该函数的返回值就是调用后返回给 A 的值"}]}]},{"ID":"20240311125211-vtw0vwi","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-vtw0vwi","updated":"20240311125211"},"Children":[{"ID":"20240311125211-gl05ha2","Type":"NodeParagraph","Properties":{"id":"20240311125211-gl05ha2","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter initial_suspend()"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"awaiter final_suspend()"},{"Type":"NodeText","Data":"​：用于给库代码编写者在协程前后挂起机会的等待器，通常返回："}]},{"ID":"20240311125211-rvk7ehi","Type":"NodeList","ListData":{},"Properties":{"id":"20240311125211-rvk7ehi","updated":"20240311125211"},"Children":[{"ID":"20240311125211-mc9m6c4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-mc9m6c4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-561fgdt","Type":"NodeParagraph","Properties":{"id":"20240311125211-561fgdt","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_always"},{"Type":"NodeText","Data":"​：必然挂起，常用于 initial。final 使用这个时需要手动销毁协程句柄"}]}]},{"ID":"20240311125211-bg6qvu4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-bg6qvu4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-qddv29s","Type":"NodeParagraph","Properties":{"id":"20240311125211-qddv29s","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_never"},{"Type":"NodeText","Data":"​：从不挂起，常用于 final"}]}]}]}]},{"ID":"20240311125211-w04syu9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-w04syu9","updated":"20240311125211"},"Children":[{"ID":"20240311125211-8uzoi2d","Type":"NodeParagraph","Properties":{"id":"20240311125211-8uzoi2d","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yield_value(T value)"},{"Type":"NodeText","Data":"​：保存操作数的值，并返回等待器，通常返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"suspend_always"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-yqo7sah","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-yqo7sah","updated":"20240311125211"},"Children":[{"ID":"20240311125211-a94vw3u","Type":"NodeParagraph","Properties":{"id":"20240311125211-a94vw3u","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void return_void()"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void return_value(T value)"},{"Type":"NodeText","Data":"​：二选一，后者对应 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_return"},{"Type":"NodeText","Data":"​ 有值的情况"}]}]},{"ID":"20240311125211-h08n6f4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-h08n6f4","updated":"20240311125211"},"Children":[{"ID":"20240311125211-240e37e","Type":"NodeParagraph","Properties":{"id":"20240311125211-240e37e","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"可选："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"V await_transform(expr e)"},{"Type":"NodeText","Data":"​，使 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await expr"},{"Type":"NodeText","Data":"​ 转变为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"co_await await_transform(expr)"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240311125211-7s0g2ax","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311125211-7s0g2ax","updated":"20240311125211"},"Children":[{"ID":"20240311125211-9hdj3v0","Type":"NodeParagraph","Properties":{"id":"20240311125211-9hdj3v0","updated":"20240311125211"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"void unhandled_exception()"},{"Type":"NodeText","Data":"​：产生异常时调用"}]}]}]}]}]}]}