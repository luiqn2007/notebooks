{"ID":"20240311121715-yf7gvgu","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2620-fe0f","id":"20240311121715-yf7gvgu","tags":"C++17","title":"launder","updated":"20240311121854"},"Children":[{"ID":"20240311121715-fhbzvfi","Type":"NodeParagraph","Properties":{"id":"20240311121715-fhbzvfi","updated":"20240311121725"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::launder()"},{"Type":"NodeText","Data":"​ 主要为了解决 C++ 的一个核心问题："}]},{"ID":"20240311121800-8k8rju6","Type":"NodeSuperBlock","Properties":{"id":"20240311121800-8k8rju6","updated":"20240311121854"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20240311121735-upgwcr5","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240311121735-upgwcr5","updated":"20240311121801"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"struct X {\n    const int n;\n};\n\nunion U {\n    X x;\n    float f;\n};\n\nint main() {\n    U u = { .x = {1} };\n    X *p = new (\u0026u.x) X(2);\n    // ...\n    return 0;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240311121758-qn4m9qc","Type":"NodeSuperBlock","Properties":{"id":"20240311121758-qn4m9qc","updated":"20240311121854"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"row"},{"ID":"20240311121735-h0gxwud","Type":"NodeParagraph","Properties":{"id":"20240311121735-h0gxwud","updated":"20240311121759"},"Children":[{"Type":"NodeText","Data":"程序中做了两件事："}]},{"ID":"20240311121735-65n1r3g","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240311121735-65n1r3g","updated":"20240311121854"},"Children":[{"ID":"20240311121735-he0kkmy","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240311121735-he0kkmy","updated":"20240311121854"},"Children":[{"ID":"20240311121735-ffjnuyg","Type":"NodeParagraph","Properties":{"id":"20240311121735-ffjnuyg","updated":"20240311121854"},"Children":[{"Type":"NodeText","Data":"初始化了一个"},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240310150550-qgwcdss","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"联合体"},{"Type":"NodeText","Data":" U，内含一个结构体 X。X 有一个"},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240310190428-0ute22n","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"常量"},{"Type":"NodeText","Data":" n 值为 1"}]}]},{"ID":"20240311121735-qls4o82","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240311121735-qls4o82","updated":"20240311121735"},"Children":[{"ID":"20240311121735-j6i2w3t","Type":"NodeParagraph","Properties":{"id":"20240311121735-j6i2w3t","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"replace new"},{"Type":"NodeText","Data":"​ 在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"u.x"},{"Type":"NodeText","Data":"​ 地址上创建了一个新的结构体 X，初始化其中常量 n 值为 2"}]}]}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"ID":"20240311121735-r4gd9jl","Type":"NodeParagraph","Properties":{"id":"20240311121735-r4gd9jl","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"那么，此时 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"u.x.n"},{"Type":"NodeText","Data":"​ 是 1 还是 2？"}]},{"ID":"20240311121735-awhphnh","Type":"NodeList","ListData":{},"Properties":{"id":"20240311121735-awhphnh","updated":"20240311121735"},"Children":[{"ID":"20240311121735-fnpvy5w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311121735-fnpvy5w","updated":"20240311121735"},"Children":[{"ID":"20240311121735-76fjy28","Type":"NodeParagraph","Properties":{"id":"20240311121735-76fjy28","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"从内存角度上来说，结果应该为 2，因为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"replace new"},{"Type":"NodeText","Data":"​ 替换了 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"u.x"},{"Type":"NodeText","Data":"​ 的对象"}]}]},{"ID":"20240311121735-cyxearx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311121735-cyxearx","updated":"20240311121735"},"Children":[{"ID":"20240311121735-h1c83yk","Type":"NodeParagraph","Properties":{"id":"20240311121735-h1c83yk","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"从编译器的角度上来说，结果可能为 1，因为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"u.x.n"},{"Type":"NodeText","Data":"​ 是一个常量，编译器优化时可以将其使用 1 替换以提高效率"}]}]},{"ID":"20240311121735-532j787","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240311121735-532j787","updated":"20240311121735"},"Children":[{"ID":"20240311121735-3na7etp","Type":"NodeParagraph","Properties":{"id":"20240311121735-3na7etp","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"从标准上来说，这个行为是未定义的。在使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"replace new"},{"Type":"NodeText","Data":"​ 后，不能使用原本的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"u.x"},{"Type":"NodeText","Data":"​，只能使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"p"},{"Type":"NodeText","Data":"​ 访问"}]}]}]},{"ID":"20240311121735-jxnui5z","Type":"NodeParagraph","Properties":{"id":"20240311121735-jxnui5z","style":"color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);","updated":"20240311121814"},"Children":[{"Type":"NodeText","Data":"C++ 规定，如果新对象在已被某个对象占据的内存上进行构建，则原始对象的指针、引用及对象名都会自动转向新对象，除非对象是一个常量类型或对象中有常量数据成员或引用类型"}]},{"ID":"20240311121735-erh7ebd","Type":"NodeParagraph","Properties":{"id":"20240311121735-erh7ebd","updated":"20240311121735"},"Children":[{"Type":"NodeText","Data":"C++17 引入 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"std::launder()"},{"Type":"NodeText","Data":"​ 方法，作用是防止编译器追踪到数据的来源以阻止编译器对数据的优化"}]},{"ID":"20240311121735-0bo7e56","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240311121735-0bo7e56","updated":"20240311121735"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"// 可以确定这个值为 2\nint n = *std::launder(\u0026u.x.n);\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}