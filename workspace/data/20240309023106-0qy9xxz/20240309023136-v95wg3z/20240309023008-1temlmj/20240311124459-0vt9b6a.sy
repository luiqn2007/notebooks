{"ID":"20240311124459-0vt9b6a","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2620-fe0f","id":"20240311124459-0vt9b6a","tags":"C++11","title":"线程局部存储","updated":"20240311125049"},"Children":[{"ID":"20240311124459-z7c77pd","Type":"NodeParagraph","Properties":{"id":"20240311124459-z7c77pd","updated":"20240311125003"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"thread_local"},{"Type":"NodeText","Data":"​ 声明一个对象的"},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240310151736-e3w7l7x","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"生命周期"},{"Type":"NodeText","Data":"是一个线程。该声明可以与 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"static"},{"Type":"NodeText","Data":"​ 与 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"extern"},{"Type":"NodeText","Data":"​ 结合。"}]},{"ID":"20240311124950-tvngvzw","Type":"NodeParagraph","Properties":{"id":"20240311124950-tvngvzw","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125020"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);"},"TextMarkType":"code","TextMarkTextContent":"thread_local"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);\"}"},{"Type":"NodeText","Data":"​ 声明的变量仅仅定义了其生命周期，并没有限制其可访问性。即允许通过 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);"},"TextMarkType":"code","TextMarkTextContent":"\u0026amp;"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);\"}"},{"Type":"NodeText","Data":"​ 取变量值交给其他线程使用，但危险性过高"}]},{"ID":"20240311125021-hcwi4ww","Type":"NodeParagraph","Properties":{"id":"20240311125021-hcwi4ww","style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);","updated":"20240311125030"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);"},"TextMarkType":"code","TextMarkTextContent":"thread_local"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);\"}"},{"Type":"NodeText","Data":"​ 声明的变量地址在运行时计算，不是一个常量，因此对其取址（"},{"Type":"NodeTextMark","Properties":{"parent-style":"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);"},"TextMarkType":"code","TextMarkTextContent":"\u0026amp;"},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);\"}"},{"Type":"NodeText","Data":"​）的值对编译器不可见"}]},{"ID":"20240311125031-0ld8jpt","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240311125031-0ld8jpt","updated":"20240311125038"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yysr"},{"Type":"NodeCodeBlockCode","Data":"#include \u003cwindows.h\u003e\n#include \u003ccstdio\u003e\n\nthread_local char name[20];\n\n// 线程执行的任务方法\nDWORD WINAPI Fun(LPVOID lpParam) {\n    sprintf(name, \"Thread %lu\", GetCurrentThreadId());\n    for (int i = 0; i \u003c 10; ++i) {\n        // 通过 TlsGetValue 获取值\n        printf(\"Thread %s: %d\\n\", name, i);\n    }\n    return 0L;\n}\n\nint main() {\n    // 创建两个线程，运行并等待结束\n    HANDLE hThread1 = CreateThread(NULL, 0, Fun, NULL, 0, NULL);\n    HANDLE hThread2 = CreateThread(NULL, 0, Fun, NULL, 0, NULL);\n    WaitForSingleObject(hThread1, INFINITE);\n    WaitForSingleObject(hThread2, INFINITE);\n    return 0;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}