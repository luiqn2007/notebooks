"use strict";const X=require("siyuan");function P(){}function xe(t){return!!t&&(typeof t=="object"||typeof t=="function")&&typeof t.then=="function"}function ke(t){return t()}function ie(){return Object.create(null)}function G(t){t.forEach(ke)}function ve(t){return typeof t=="function"}function Be(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Ee(t){return Object.keys(t).length===0}function o(t,e){t.appendChild(e)}function j(t,e,l){t.insertBefore(e,l||null)}function A(t){t.parentNode&&t.parentNode.removeChild(t)}function v(t){return document.createElement(t)}function T(t){return document.createTextNode(t)}function q(){return T(" ")}function qe(){return T("")}function R(t,e,l,n){return t.addEventListener(e,l,n),()=>t.removeEventListener(e,l,n)}function u(t,e,l){l==null?t.removeAttribute(e):t.getAttribute(e)!==l&&t.setAttribute(e,l)}function De(t,e,l){const n=new Set;for(let c=0;c<t.length;c+=1)t[c].checked&&n.add(t[c].__value);return l||n.delete(e),Array.from(n)}function ge(t){let e;return{p(...l){e=l,e.forEach(n=>t.push(n))},r(){e.forEach(l=>t.splice(t.indexOf(l),1))}}}function Ie(t){return Array.from(t.childNodes)}function oe(t,e){t.value=e??""}function Me(t,e,l,n){l==null?t.style.removeProperty(e):t.style.setProperty(e,l,n?"important":"")}let Y;function O(t){Y=t}function Ne(){if(!Y)throw new Error("Function called outside component initialization");return Y}const $=[],Z=[];let Q=[];const re=[],Pe=Promise.resolve();let ee=!1;function Se(){ee||(ee=!0,Pe.then(le))}function te(t){Q.push(t)}const K=new Set;let L=0;function le(){if(L!==0)return;const t=Y;do{try{for(;L<$.length;){const e=$[L];L++,O(e),ze(e.$$)}}catch(e){throw $.length=0,L=0,e}for(O(null),$.length=0,L=0;Z.length;)Z.pop()();for(let e=0;e<Q.length;e+=1){const l=Q[e];K.has(l)||(K.add(l),l())}Q.length=0}while($.length);for(;re.length;)re.pop()();ee=!1,K.clear(),O(t)}function ze(t){if(t.fragment!==null){t.update(),G(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(te)}}function Te(t){const e=[],l=[];Q.forEach(n=>t.indexOf(n)===-1?e.push(n):l.push(n)),l.forEach(n=>n()),Q=e}const H=new Set;let F;function Oe(){F={r:0,c:[],p:F}}function Ae(){F.r||G(F.c),F=F.p}function ne(t,e){t&&t.i&&(H.delete(t),t.i(e))}function Re(t,e,l,n){if(t&&t.o){if(H.has(t))return;H.add(t),F.c.push(()=>{H.delete(t),n&&(l&&t.d(1),n())}),t.o(e)}else n&&n()}function ae(t,e){const l=e.token={};function n(c,d,s,r){if(e.token!==l)return;e.resolved=r;let a=e.ctx;s!==void 0&&(a=a.slice(),a[s]=r);const i=c&&(e.current=c)(a);let g=!1;e.block&&(e.blocks?e.blocks.forEach((p,_)=>{_!==d&&p&&(Oe(),Re(p,1,1,()=>{e.blocks[_]===p&&(e.blocks[_]=null)}),Ae())}):e.block.d(1),i.c(),ne(i,1),i.m(e.mount(),e.anchor),g=!0),e.block=i,e.blocks&&(e.blocks[d]=i),g&&le()}if(xe(t)){const c=Ne();if(t.then(d=>{O(c),n(e.then,1,e.value,d),O(null)},d=>{if(O(c),n(e.catch,2,e.error,d),O(null),!e.hasCatch)throw d}),e.current!==e.pending)return n(e.pending,0),!0}else{if(e.current!==e.then)return n(e.then,1,e.value,t),!0;e.resolved=t}}function ue(t,e,l){const n=e.slice(),{resolved:c}=t;t.current===t.then&&(n[t.value]=c),t.current===t.catch&&(n[t.error]=c),t.block.p(n,l)}function me(t,e){t.d(1),e.delete(t.key)}function be(t,e,l,n,c,d,s,r,a,i,g,p){let _=t.length,x=d.length,f=_;const E={};for(;f--;)E[t[f].key]=f;const M=[],N=new Map,D=new Map,y=[];for(f=x;f--;){const w=p(c,d,f),I=l(w);let h=s.get(I);h?n&&y.push(()=>h.p(w,e)):(h=i(I,w),h.c()),N.set(I,M[f]=h),I in E&&D.set(I,Math.abs(f-E[I]))}const k=new Set,m=new Set;function C(w){ne(w,1),w.m(r,g),s.set(w.key,w),g=w.first,x--}for(;_&&x;){const w=M[x-1],I=t[_-1],h=w.key,B=I.key;w===I?(g=w.first,_--,x--):N.has(B)?!s.has(h)||k.has(h)?C(w):m.has(B)?_--:D.get(h)>D.get(B)?(m.add(h),C(w)):(k.add(B),_--):(a(I,s),_--)}for(;_--;){const w=t[_];N.has(w.key)||a(w,s)}for(;x;)C(M[x-1]);return G(y),M}function Ge(t,e,l,n){const{fragment:c,after_update:d}=t.$$;c&&c.m(e,l),n||te(()=>{const s=t.$$.on_mount.map(ke).filter(ve);t.$$.on_destroy?t.$$.on_destroy.push(...s):G(s),t.$$.on_mount=[]}),d.forEach(te)}function je(t,e){const l=t.$$;l.fragment!==null&&(Te(l.after_update),G(l.on_destroy),l.fragment&&l.fragment.d(e),l.on_destroy=l.fragment=null,l.ctx=[])}function Fe(t,e){t.$$.dirty[0]===-1&&($.push(t),Se(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Le(t,e,l,n,c,d,s,r=[-1]){const a=Y;O(t);const i=t.$$={fragment:null,ctx:[],props:d,update:P,not_equal:c,bound:ie(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:ie(),dirty:r,skip_bound:!1,root:e.target||a.$$.root};s&&s(i.root);let g=!1;if(i.ctx=l?l(t,e.props||{},(p,_,...x)=>{const f=x.length?x[0]:_;return i.ctx&&c(i.ctx[p],i.ctx[p]=f)&&(!i.skip_bound&&i.bound[p]&&i.bound[p](f),g&&Fe(t,p)),_}):[],i.update(),g=!0,G(i.before_update),i.fragment=n?n(i.ctx):!1,e.target){if(e.hydrate){const p=Ie(e.target);i.fragment&&i.fragment.l(p),p.forEach(A)}else i.fragment&&i.fragment.c();e.intro&&ne(t.$$.fragment),Ge(t,e.target,e.anchor,e.customElement),le()}O(a)}class $e{$destroy(){je(this,1),this.$destroy=P}$on(e,l){if(!ve(l))return P;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(l),()=>{const c=n.indexOf(l);c!==-1&&n.splice(c,1)}}$set(e){this.$$set&&!Ee(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}async function se(t,e){let l=await X.fetchSyncPost(t,e);return l.code===0?l.data:null}async function Qe(){return se("/api/notebook/lsNotebooks","")}async function Ve(t,e,l){return se("/api/block/transferBlockRef",{fromID:t,toID:e,refIDs:l})}async function J(t){return se("/api/query/sql",{stmt:t})}async function de(t){let e=`select * from blocks where id ='${t}'`;return(await J(e))[0]}let ye=new Map;const Xe=t=>{ye=t};let S,Ye=t=>{S=t};async function He(t){let e=`select * from blocks where path regexp '.*/${t}/[0-9a-z-]+.sy' and type='d'
    order by hpath desc;`;return await J(e)}function Je(t){return t==null||t===!1||typeof t=="string"&&t.trim()===""?!0:(t==null?void 0:t.length)===0}function fe(t,e,l){const n=t.slice();return n[23]=e[l],n}function he(t,e,l){const n=t.slice();return n[23]=e[l],n}function Ke(t){let e,l,n=t[28].message+"",c;return{c(){e=v("p"),l=T("找不到 "),c=T(n),Me(e,"color","red"),u(e,"class","svelte-1vlp4ip")},m(d,s){j(d,e,s),o(e,l),o(e,c)},p:P,d(d){d&&A(e)}}}function Ue(t){let e,l,n,c,d,s,r,a,i,g,p,_,x,f=[],E=new Map,M,N,D=t[4];const y=k=>k[23].id;for(let k=0;k<D.length;k+=1){let m=he(t,D,k),C=y(m);E.set(C,f[k]=pe(C,m))}return{c(){e=v("div"),l=v("div"),n=v("div"),c=v("input"),d=q(),s=v("div"),s.textContent=`${S.pannel.refs.table[0]}`,r=q(),a=v("div"),a.textContent=`${S.pannel.refs.table[1]}`,i=q(),g=v("div"),g.textContent=`${S.pannel.refs.table[2]}`,p=q(),_=v("div"),_.textContent=`${S.pannel.refs.table[3]}`,x=q();for(let k=0;k<f.length;k+=1)f[k].c();u(c,"type","checkbox"),u(c,"class","svelte-1vlp4ip"),u(n,"class","cell-0 svelte-1vlp4ip"),u(s,"class","cell svelte-1vlp4ip"),u(a,"class","cell svelte-1vlp4ip"),u(g,"class","cell svelte-1vlp4ip"),u(_,"class","cell svelte-1vlp4ip"),u(l,"class","row header svelte-1vlp4ip"),u(e,"class","refs-table svelte-1vlp4ip")},m(k,m){j(k,e,m),o(e,l),o(l,n),o(n,c),t[14](c),o(l,d),o(l,s),o(l,r),o(l,a),o(l,i),o(l,g),o(l,p),o(l,_),o(e,x);for(let C=0;C<f.length;C+=1)f[C]&&f[C].m(e,null);M||(N=R(c,"change",t[6]),M=!0)},p(k,m){m&1828&&(D=k[4],f=be(f,m,y,1,k,D,E,e,me,pe,null,he))},d(k){k&&A(e),t[14](null);for(let m=0;m<f.length;m+=1)f[m].d();M=!1,N()}}}function pe(t,e){let l,n,c,d,s,r,a=e[9](e[23].type)+"",i,g,p,_=e[23].notebook+"",x,f,E,M=e[23].doc+"",N,D,y,k=nt(e[23].content,50)+"",m,C,w,I,h;function B(...b){return e[17](e[23],...b)}return w=ge(e[16][1]),{key:t,first:null,c(){l=v("div"),n=v("div"),c=v("input"),d=q(),s=v("div"),r=v("span"),i=T(a),g=q(),p=v("div"),x=T(_),f=q(),E=v("div"),N=T(M),D=q(),y=v("div"),m=T(k),C=q(),u(c,"type","checkbox"),c.__value=e[23].id,c.value=c.__value,u(c,"class","svelte-1vlp4ip"),u(n,"class","cell-0 svelte-1vlp4ip"),u(r,"class","svelte-1vlp4ip"),u(s,"class","cell b3-tooltips b3-tooltips__n blockType svelte-1vlp4ip"),u(s,"aria-label",e[23].id),u(p,"class","cell svelte-1vlp4ip"),u(E,"class","cell svelte-1vlp4ip"),u(y,"class","cell svelte-1vlp4ip"),u(l,"class","row svelte-1vlp4ip"),w.p(c),this.first=l},m(b,z){j(b,l,z),o(l,n),o(n,c),c.checked=~(e[2]||[]).indexOf(c.__value),o(l,d),o(l,s),o(s,r),o(r,i),o(l,g),o(l,p),o(p,x),o(l,f),o(l,E),o(E,N),o(l,D),o(l,y),o(y,m),o(l,C),I||(h=[R(c,"change",e[15]),R(c,"change",e[5]),R(r,"click",B),R(r,"keydown",st)],I=!0)},p(b,z){e=b,z&4&&(c.checked=~(e[2]||[]).indexOf(c.__value))},d(b){b&&A(l),w.r(),I=!1,G(h)}}}function We(t){let e;return{c(){e=v("p"),e.textContent="查询中...",u(e,"class","svelte-1vlp4ip")},m(l,n){j(l,e,n)},p:P,d(l){l&&A(e)}}}function Ze(t){return{c:P,m:P,p:P,d:P}}function et(t){let e=[],l=new Map,n,c=t[22];const d=s=>s[23].id;for(let s=0;s<c.length;s+=1){let r=fe(t,c,s),a=d(r);l.set(a,e[s]=_e(a,r))}return{c(){for(let s=0;s<e.length;s+=1)e[s].c();n=qe()},m(s,r){for(let a=0;a<e.length;a+=1)e[a]&&e[a].m(s,r);j(s,n,r)},p(s,r){r&2049&&(c=s[22],e=be(e,r,d,1,s,c,l,n.parentNode,me,_e,n,fe))},d(s){for(let r=0;r<e.length;r+=1)e[r].d(s);s&&A(n)}}}function _e(t,e){let l,n,c,d=e[23].hpath.split("/").pop()+"",s,r,a,i,g;return a=ge(e[16][0]),{key:t,first:null,c(){l=v("label"),n=v("input"),c=q(),s=T(d),r=q(),u(n,"type","radio"),u(n,"name","options"),n.__value=e[23].id,n.value=n.__value,u(n,"class","svelte-1vlp4ip"),u(l,"class","svelte-1vlp4ip"),a.p(n),this.first=l},m(p,_){j(p,l,_),o(l,n),n.checked=n.__value===e[0],o(l,c),o(l,s),o(l,r),i||(g=R(n,"change",e[19]),i=!0)},p(p,_){e=p,_&1&&(n.checked=n.__value===e[0])},d(p){p&&A(l),a.r(),i=!1,g()}}}function tt(t){let e;return{c(){e=v("p"),e.textContent="查询中...",u(e,"class","svelte-1vlp4ip")},m(l,n){j(l,e,n)},p:P,d(l){l&&A(e)}}}function lt(t){let e,l,n,c,d,s,r,a,i,g,p,_,x,f,E,M,N,D,y={ctx:t,current:null,token:null,hasCatch:!0,pending:We,then:Ue,catch:Ke,value:4,error:28};ae(t[10],y);let k={ctx:t,current:null,token:null,hasCatch:!1,pending:tt,then:et,catch:Ze,value:22};return ae(t[11],k),{c(){e=v("main"),l=v("section"),y.block.c(),n=q(),c=v("div"),d=q(),s=v("section"),r=v("div"),a=v("div"),i=v("input"),g=q(),p=v("div"),_=v("button"),_.textContent=`${S.pannel.transBtn.btn}`,x=q(),f=v("div"),E=v("h4"),E.textContent=`${S.pannel.dstOptions.candidate}`,M=q(),k.block.c(),u(l,"id","refs"),u(l,"class","fn__flex-1 svelte-1vlp4ip"),u(c,"class","layout__resize--lr layout__resize svelte-1vlp4ip"),u(i,"class","b3-text-field fn__flex-center svelte-1vlp4ip"),u(i,"placeholder",S.pannel.transBtn.placeholder),u(a,"class","svelte-1vlp4ip"),u(_,"class","b3-button b3-button--outline fn__flex-center svelte-1vlp4ip"),u(p,"class","svelte-1vlp4ip"),u(r,"id","transBtn"),u(r,"class","svelte-1vlp4ip"),u(E,"class","svelte-1vlp4ip"),u(f,"id","dstOptions"),u(f,"class","svelte-1vlp4ip"),u(s,"id","dsts"),u(s,"class","svelte-1vlp4ip"),u(e,"id","main"),u(e,"class","fn__flex fn__flex-1 svelte-1vlp4ip")},m(m,C){j(m,e,C),o(e,l),y.block.m(l,y.anchor=null),y.mount=()=>l,y.anchor=null,o(e,n),o(e,c),o(e,d),o(e,s),o(s,r),o(r,a),o(a,i),oe(i,t[3]),o(r,g),o(r,p),o(p,_),o(s,x),o(s,f),o(f,E),o(f,M),k.block.m(f,k.anchor=null),k.mount=()=>f,k.anchor=null,N||(D=[R(i,"input",t[18]),R(_,"click",t[7])],N=!0)},p(m,[C]){t=m,ue(y,t,C),C&8&&i.value!==t[3]&&oe(i,t[3]),ue(k,t,C)},i:P,o:P,d(m){m&&A(e),y.block.d(),y.token=null,y=null,k.block.d(),k.token=null,k=null,N=!1,G(D)}}}function nt(t,e){return t.length>e?t.slice(0,e)+"...":t}const st=()=>{};function ct(t,e,l){let{plugin:n}=e,{srcBlockID:c}=e,d=[],s,r="",a=[],i="";function g(){s&&(a.length===0?(l(1,s.checked=!1,s),l(1,s.indeterminate=!1,s)):a.length===d.length?(l(1,s.checked=!0,s),l(1,s.indeterminate=!1,s)):(l(1,s.checked=!1,s),l(1,s.indeterminate=!0,s)))}function p(){s.checked?l(2,a=d.map(B=>B.id)):l(2,a=[])}async function _(){let h=`select * from blocks where id in (
        select block_id from refs where def_block_id = '${c}') order by updated desc`,B=await J(h);l(4,d=[]);for(let b of B)d.push({id:b.id,type:b.type,notebook:ye.get(b.box)??b.box,doc:b.hpath,content:b.content});return d}async function x(){let h=await de(c),b=h.path.slice(1).split("/"),z=null;console.log(b),b.length>1&&(z=b[b.length-2],console.log(z));let V=await He(h.root_id);V=V??[];let ce=V.sort((we,Ce)=>we.hpath.localeCompare(Ce.hpath));return z!=null&&ce.unshift(await de(z)),ce}async function f(){if(a.length===0){X.showMessage(S.msg.NoRefChoose);return}let h=`select * from blocks where id = "${i}" limit 1`,B=await J(h);if(Je(B)){X.showMessage(S.msg.NoDst.replace("${dstBlockID}",i));return}Ve(c,i,a)}function E(h,B){B.stopPropagation(),console.log(B),n.addFloatLayer({ids:[h],x:B.clientX,y:B.clientY});let b=window.siyuan.blockPanels,V=b[b.length-1].element;V.style.zIndex="999"}const M=h=>{var b;return((b=S.btype)==null?void 0:b[h])??h};let N=_(),D=x();const y=[[],[]];function k(h){Z[h?"unshift":"push"](()=>{s=h,l(1,s)})}function m(){a=De(y[1],this.__value,this.checked),l(2,a)}const C=(h,B)=>{E(h.id,B)};function w(){i=this.value,l(3,i),l(0,r)}function I(){r=this.__value,l(0,r)}return t.$$set=h=>{"plugin"in h&&l(12,n=h.plugin),"srcBlockID"in h&&l(13,c=h.srcBlockID)},t.$$.update=()=>{t.$$.dirty&1&&l(3,i=r)},[r,s,a,i,d,g,p,f,E,M,N,D,n,c,k,m,y,C,w,I]}class it extends $e{constructor(e){super(),Le(this,e,ct,lt,Be,{plugin:12,srcBlockID:13})}}let U,W;const ot='<symbol id="iconTransfer" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3385" width="16" height="16"><path d="M512 85.333333a42.666667 42.666667 0 1 0 0 85.333334 341.461333 341.461333 0 0 1 333.525333 268.373333l-58.453333-29.226667a42.666667 42.666667 0 0 0-38.144 76.330667l128 64A42.666667 42.666667 0 0 0 938.666667 511.957333C938.666667 276.352 747.648 85.333333 512 85.333333z" p-id="3386"></path><path d="M314.496 140.202667a174.336 174.336 0 1 0 0 348.586666 174.336 174.336 0 0 0 0-348.586666zM225.536 314.453333a89.002667 89.002667 0 1 1 177.962667 0 89.002667 89.002667 0 0 1-177.962667 0zM709.461333 535.168a174.293333 174.293333 0 1 0 0 348.586667 174.293333 174.293333 0 0 0 0-348.586667z m-88.96 174.293333a88.96 88.96 0 1 1 177.962667 0 88.96 88.96 0 0 1-177.962667 0z" p-id="3387"></path><path d="M105.6 475.733333a42.666667 42.666667 0 0 1 41.514667-1.877333l128 64a42.666667 42.666667 0 1 1-38.186667 76.288l-58.453333-29.184A341.418667 341.418667 0 0 0 512 853.333333a42.666667 42.666667 0 1 1 0 85.333334C276.352 938.666667 85.333333 747.648 85.333333 512a42.666667 42.666667 0 0 1 20.266667-36.266667z" p-id="3388"></path></symbol>';class rt extends X.Plugin{async onload(){U=e=>this.onBlockGutterClicked(e),W=e=>this.onDocGutterClicked(e),this.addIcons(ot),this.eventBus.on("click-blockicon",U),this.eventBus.on("click-editortitleicon",W),Ye(this.i18n),await this.queryNotebooks()}onLayoutReady(){}onunload(){this.eventBus.off("click-blockicon",U),this.eventBus.off("click-editortitleicon",W)}onBlockGutterClicked({detail:e}){if(e.blockElements.length>1)return;let l=e.menu,c=e.blockElements[0].getAttribute("data-node-id");l.addItem({label:this.i18n.name,icon:"iconTransfer",click:()=>{this.showTransferDialog(c)}})}onDocGutterClicked({detail:e}){let l=e.data.id;e.menu.addItem({label:this.i18n.name,icon:"iconTransfer",click:()=>{this.showTransferDialog(l)}})}showTransferDialog(e){let l=new X.Dialog({title:this.i18n.name,content:'<div id="pannel" class="fn__flex fn__flex-1"></div>',width:"60%",height:"50%"});new it({target:l.element.querySelector("#pannel"),props:{plugin:this,srcBlockID:e}})}async queryNotebooks(){let e=new Map;try{(await Qe()).notebooks.forEach(c=>{e.set(c.id,c.name)})}catch(l){console.error(l)}return Xe(e),e}}module.exports=rt;
