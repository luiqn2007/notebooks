/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var y={};y.d=(h,t)=>{for(var e in t)y.o(t,e)&&!y.o(h,e)&&Object.defineProperty(h,e,{enumerable:!0,get:t[e]})},y.o=(h,t)=>Object.prototype.hasOwnProperty.call(h,t),y.r=h=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(h,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(h,"__esModule",{value:!0})};var F={};y.r(F),y.d(F,{default:()=>M});const O=require("siyuan"),A=`${window.siyuan.config.system.workspaceDir}`,w=`${window.siyuan.config.system.dataDir}`,$="./assets",d=!1,D=h=>{const t="sidebar memo",e=i=>{const n=i.getFullYear(),r=String(i.getMonth()+1).padStart(2,"0"),s=String(i.getDate()).padStart(2,"0"),l=String(i.getHours()).padStart(2,"0"),a=String(i.getMinutes()).padStart(2,"0"),u=String(i.getSeconds()).padStart(2,"0");return`${n}-${r}-${s} ${l}:${a}:${u}`},o=(i,n,r)=>{const s=e(new Date);r?console.log(`[${t}] [${s}] [${i}] [${h}] ${n}`,r):console.log(`[${t}] [${s}] [${i}] [${h}] ${n}`)};return{debug:(i,n)=>o("DEBUG",i,n),info:(i,n)=>o("INFO",i,n),warn:(i,n)=>{const r=e(new Date);n?console.warn(`[${t}] [${r}] [WARN] ${i}`,n):console.warn(`[${t}] [${r}] [WARN] ${i}`)},error:(i,n)=>{typeof i=="string"?o("ERROR",i,n):console.error(`[${t}] [${e(new Date)}] [ERROR] [${h}] error occurred`,i)}}};var C=(h,t,e)=>new Promise((o,i)=>{var n=l=>{try{s(e.next(l))}catch(a){i(a)}},r=l=>{try{s(e.throw(l))}catch(a){i(a)}},s=l=>l.done?o(l.value):Promise.resolve(l.value).then(n,r);s((e=e.apply(h,t)).next())});function B(h){return C(this,null,function*(){return new Promise(t=>setTimeout(t,h))})}var v=(h,t,e)=>new Promise((o,i)=>{var n=l=>{try{s(e.next(l))}catch(a){i(a)}},r=l=>{try{s(e.throw(l))}catch(a){i(a)}},s=l=>l.done?o(l.value):Promise.resolve(l.value).then(n,r);s((e=e.apply(h,t)).next())});const m="menu-config";class M extends O.Plugin{constructor(){super(...arguments),this.minPaddingRight=150,this.refreshEditorBindThis=this.refreshEditor.bind(this)}onload(){this.data[m]={openSideBarMemo:!1};const t=(0,O.getFrontend)();this.isMobile=t==="mobile"||t==="browser-mobile",this.topBarElement=this.addTopBar({icon:"iconM",title:this.i18n.name,position:"right",callback:()=>{if(this.isMobile)this.addMenu();else{let e=this.topBarElement.getBoundingClientRect();e.width===0&&(e=document.querySelector("#barMore").getBoundingClientRect()),e.width===0&&(e=document.querySelector("#barPlugins").getBoundingClientRect()),this.addMenu(e)}}}),this.logger=D("main")}onLayoutReady(){return v(this,null,function*(){yield this.loadData(m),this.editorNode=document.querySelector("div.layout__center"),this.memoObservers={},this.mainNodeObservers={},this.mainNodeAttrObserver={},this.protyleObservers={},this.onChange=!1,this.alignCenter=!0,d&&this.logger.info("\u627E\u5230\u7F16\u8F91\u5668, editor =>",this.editorNode),this.initHandleFunctions(),this.openSideBar(this.data[m].openSideBarMemo)})}onunload(){this.openSideBar(!1,!1)}initSettingTab(){const t=document.createElement("textarea");this.setting=new O.Setting({confirmCallback:()=>{this.saveData(m,{readonlyText:t.value})}}),this.setting.addItem({title:"Readonly text",createActionElement:()=>(t.className="b3-text-field fn__block",t.placeholder="Readonly text in the menu",t.value=this.data[m].readonlyText,t)});const e=document.createElement("button");e.className="b3-button b3-button--outline fn__flex-center fn__size200",e.textContent="Open",e.addEventListener("click",()=>{window.open("https://github.com/siyuan-note/plugin-sample")}),this.setting.addItem({title:"Open plugin url",description:"Open plugin url in browser",actionElement:e})}addMenu(t){const e=new O.Menu("topBarSample");this.isMobile||e.addItem({icon:"iconLayoutBottom",label:this.data[m].openSideBarMemo?this.i18n.closeSidebarMemo:this.i18n.openSidebarMemo,click:()=>{this.openSideBar(!this.data[m].openSideBarMemo)}}),this.isMobile?e.fullscreen():e.open({x:t.right,y:t.bottom,isLeft:!0})}initHandleFunctions(){this.handleMainNode=(t,e)=>v(this,null,function*(){const o=[];for(const i of t){if(o.indexOf(i.target)!=-1)continue;if(o.push(i.target),d&&this.logger.info("Main Node Observer Callback, detail=>",{mutation:i,observer:e}),this.onChange)return;this.onChange=!0;const n=e.mainNode,r=e.sidebar;setTimeout(()=>{this.data[m].openSideBarMemo?this.refreshSideBarMemos(n,r):this.openSideBar(!1),this.onChange=!1},0)}}),this.handleMemoNode=(t,e)=>{const o=[];for(const i of t)if(i.type==="attributes"){if(o.indexOf(i.target)!=-1)continue;if(o.push(i.target),d&&this.logger.info("Memo Observer Callback, detail=>",{mutation:i,observer:e}),!this.data[m].openSideBarMemo){this.openSideBar(!1);return}const n=i.target,r=this.getBlockNode(n),s=r.getAttribute("data-node-id"),l=r.querySelectorAll('span[data-type*="inline-memo"]'),a=this.getMergedMemos(l),u=e.sidebar;let f=0;for(let c=0;c<l.length;++c)l[c]==n&&(f=c);let g=0;for(let c=0;c<a.length;++c)a[c].originIndexs.indexOf(f)!=-1&&(g=c);const b=u.querySelector(`div[id="protyle-sidebar-memo-${s}-${g}"]`);if(!b)return this.refreshSideBarMemos(e.mainNode,u);const E=b.querySelector('div[data-content-type="memo"]');if(E.textContent!=a[g].totalContent)return this.refreshSideBarMemos(e.mainNode,u);const p=a[g].memo;E.innerText=`${p}`}},this.handleMainNodeAttr=(t,e)=>v(this,null,function*(){const o=[];for(const i of t)if(i.type=="attributes"){if(o.indexOf(i.target)!=-1)continue;o.push(i.target),d&&this.logger.info("Attr Observer\u89E6\u53D1, detail=>",{mutation:i,observer:e});const n=e.mainNode,r=e.sidebar,s=parseFloat(getComputedStyle(n).paddingRight),l=n.parentElement.dataset.fullwidth,a=n.parentElement.parentElement.getAttribute("class").indexOf("fn__none")==-1;if(a&&!l&&s<this.minPaddingRight)d&&this.logger.info("\u7F16\u8F91\u5668\u5BBD\u5EA6\u4E0D\u8DB3\uFF0C\u53D6\u6D88\u4FA7\u680F\uFF0CpaddingRight=>",{paddingRight:s}),(0,O.showMessage)(this.i18n.noEnoughPaddingRight,2e3,"info"),this.openSideBar(!1);else{if(d&&this.logger.info("\u5BBD\u5EA6\u6539\u53D8\uFF0C\u8FDB\u884C\u5237\u65B0\uFF0CpaddingRight=>",{paddingRight:s}),!a){d&&this.logger.info("\u8FD9\u4E2A\u9875\u9762\u6CA1\u6E32\u67D3\uFF0C\u4E0D\u7740\u6025\uFF0CmainNode=>",{mainNode:n});return}r?.remove(),yield this.refreshEditor()}}}),this.handelProtyleNodeAttr=(t,e)=>v(this,null,function*(){const o=[];for(const i of t)if(console.log(i),i.type=="attributes"){if(o.indexOf(i.target)!=-1)continue;o.push(i.target),d&&this.logger.info("Protyle Observer\u89E6\u53D1, detail=>",{mutation:i,observer:e});const n=e.mainNode;if(i.target.getAttribute("class").indexOf("fn__none")==-1){const s=this.addSideBar(n);yield this.waitForDataLoading(n),this.refreshSideBarMemos(n,s)}}})}openSideBar(t,e=!0){if(d&&this.logger.info("open sidebar \u89E6\u53D1, open=>",{open:t}),t?(this.memoObservers={},this.mainNodeObservers={},this.eventBus.on("loaded-protyle",this.refreshEditorBindThis),this.refreshEditor()):(this.eventBus.off("loaded-protyle",this.refreshEditorBindThis),Object.keys(this.mainNodeObservers).forEach(i=>{var n;(n=this.mainNodeObservers[i])==null||n.disconnect(),d&&this.logger.info("\u5173\u95EDmainNodeObserver=>",{id:i})}),d&&this.logger.info(`\u5173\u95EDmainNodeAttrObserver${Object.keys(this.mainNodeAttrObserver).length}\u4E2A`),Object.values(this.mainNodeAttrObserver).forEach(i=>i.disconnect()),d&&this.logger.info(`\u5173\u95EDprotyleObserver${Object.keys(this.protyleObservers).length}\u4E2A`),Object.values(this.protyleObservers).forEach(i=>i.disconnect()),Object.keys(this.memoObservers).forEach(i=>{var n;(n=this.memoObservers[i])==null||n.forEach(r=>{r.disconnect()}),d&&this.logger.info("\u5173\u95EDmemoObserver=>",{id:i})}),this.editorNode.querySelectorAll("div.protyle-wysiwyg").forEach(i=>{const n=i.parentElement.querySelector("#protyle-sidebar");n?.remove()}),d&&this.logger.info("\u4FA7\u680F\u5DF2\u5173\u95ED\uFF0CObserver\u5DF2\u5173\u95ED")),e){const o={openSideBarMemo:t};this.data[m]=o,this.saveData(m,o)}}addSideBar(t){let e=t.parentElement.querySelector("#protyle-sidebar");const o=t.parentElement.querySelector("div.protyle-title"),i=parseFloat(globalThis.getComputedStyle(t).paddingRight),n=t.parentElement.dataset.fullwidth;if(t.parentElement.parentElement.getAttribute("class").indexOf("fn__none")==-1&&!n&&i<this.minPaddingRight)return d&&this.logger.info("\u7F16\u8F91\u5668\u5BBD\u5EA6\u4E0D\u8DB3\uFF0C\u53D6\u6D88\u4FA7\u680F\uFF0Cdetail=>",{mainNode:t,paddingRight:i}),(0,O.showMessage)(this.i18n.noEnoughPaddingRight,2e3,"info"),null;if(d&&this.logger.info("\u7F16\u8F91\u5668\u5BBD\u5EA6\u8DB3\u591F\uFF0Cdetail=>",{mainNode:t,paddingRight:i}),!e){e=document.createElement("div"),e.scrollTop=t.scrollTop,e.id="protyle-sidebar",o.insertAdjacentElement("beforeend",e);const s=n?230:i-20;e.style.cssText=`position:absolute;right:-${s}px;width:${s}px;z-index:3;`,e.scrollTop=o.scrollTop,t.style.minWidth="90%"}return e}adjustAlign(t,e,o,i){if(t<0)return null;let n=0;const r=o[e[0]].offsetTop,s=o[e[0]].scrollHeight,l=o[e[e.length-1]].offsetTop,a=o[e[e.length-1]].scrollHeight;if(e[0]){const p=parseFloat(getComputedStyle(o[e[0]-1]).getPropertyValue("margin-bottom")),c=o[e[0]-1].offsetTop+o[e[0]-1].scrollHeight;if(n=r-(c+p),!n)return d&&this.logger.info("\u68C0\u6D4B\u5230\u76F8\u63A5\uFF0C\u8FDB\u884C\u4E0B\u4E00\u6B21\u9012\u5F52, detail=>",{prevMargin:p,prevNodeOffset:c}),this.adjustAlign(t-1,[e[0]-1,...e],o,i)}else n=r;if(d&&this.logger.info("\u8282\u70B9\u521D\u59CB\u8BA1\u7B97, detail=>",{nowIdx:t,teamIdxs:e,firstNodeOffset:r,firstNodeHeisht:s,lastNodeOffset:l,lastNodeHeight:a,distance:n}),e.length==1)return this.adjustAlign(t-1,[t-1],o,i);const u=e.map(p=>{const c=o[p].dataset.nodeId,S=i.querySelector(`div[data-node-id="${c}"]`);return{node:S,offset:this.getRelatedTop(i,S),height:S.scrollHeight}}).sort((p,c)=>p.offset-c.offset);d&&this.logger.info("\u83B7\u5F97\u5BF9\u5E94blocks=>",u);const f=(u[u.length-1].offset+u[u.length-1].height+u[0].offset)/2,g=(r+l+a)/2,b=Math.min(n,g-f),E=parseFloat(o[e[0]].style.top)-b;return d&&this.logger.info("\u79FB\u52A8\u5757\u6574\u4F53\u5230\u65B0\u4F4D\u7F6E, detail=>",{blocksCenter:f,memoCenter:g,offset:b,topOffset:E}),e.forEach(p=>{o[p].style.top=`${E}px`}),t&&b==n?(d&&this.logger.info("\u79FB\u52A8\u540E\u76F8\u63A5\uFF0C\u8FDB\u884C\u4E0B\u4E00\u6B21\u9012\u5F52"),this.adjustAlign(t-1,[e[0]-1,...e],o,i)):this.adjustAlign(t-1,[t-1],o,i)}refreshEditor(){return v(this,null,function*(){const t=this.editorNode.querySelectorAll("div.protyle-wysiwyg");d&&this.logger.info("\u83B7\u53D6mainNode=>",t);const e=Object.assign({},this.mainNodeObservers),o=[];let i=!1;t.forEach(n=>{const r=this.getMainNodeID(n);d&&this.logger.info("\u7B49\u5F85\u6570\u636E\u52A0\u8F7D\u5B8C\u6210..."),e[r]&&delete e[r];const s=this.addSideBar(n);o.push(this.waitForDataLoading(n).then(()=>v(this,null,function*(){if(d&&this.logger.info("\u6570\u636E\u52A0\u8F7D\u5B8C\u6210"),!s){i=!0;return}setTimeout(()=>{this.refreshSideBarMemos(n,s)},0);let l=this.mainNodeObservers[r];l?l.disconnect():(d&&this.logger.info(`\u5411${r}\u4E2D\u52A0\u5165mainNodeObserver`),l=new MutationObserver(this.handleMainNode.bind(this)),this.mainNodeObservers[r]=l),l.mainNode=n,l.sidebar=s,l.observe(n,{childList:!0,subtree:!0});let a=this.mainNodeAttrObserver[r];a?a.disconnect():(d&&this.logger.info(`\u5411${r}\u4E2D\u52A0\u5165mainNodeAttrObserver`),a=new MutationObserver(this.handleMainNodeAttr.bind(this)),this.mainNodeAttrObserver[r]=a),a.observe(n,{attributes:!0}),a.mainNode=n,a.sidebar=s;let u=this.protyleObservers[r];u?u.disconnect():(d&&this.logger.info(`\u5411${r}\u4E2D\u52A0\u5165mainNodeObserver`),u=new MutationObserver(this.handelProtyleNodeAttr.bind(this)),this.protyleObservers[r]=u),u.mainNode=n,u.sidebar=s,u.observe(n.parentElement.parentElement,{attributes:!0})})))}),yield Promise.all(o),Object.keys(e).forEach(n=>{var r,s,l,a;(r=this.mainNodeObservers[n])==null||r.disconnect(),(s=this.mainNodeAttrObserver[n])==null||s.disconnect(),(l=this.protyleObservers[n])==null||l.disconnect(),(a=this.memoObservers[n])==null||a.forEach(u=>{u.disconnect()}),delete this.mainNodeObservers[n],delete this.mainNodeAttrObserver[n],delete this.protyleObservers[n],delete this.memoObservers[n]}),i&&this.openSideBar(!1)})}refreshSideBarMemos(t,e){var o;const i=t.querySelectorAll('span[data-type*="inline-memo"]'),n=this.getMergedMemos(i),r=document.createElement("div"),s={},l=this.getMainNodeID(t);(o=this.memoObservers[l])==null||o.forEach(a=>{a.disconnect()}),this.memoObservers[l]=[],i.forEach(a=>{const u=new MutationObserver(this.handleMemoNode.bind(this));u.observe(a,{attributes:!0}),u.mainNode=t,u.sidebar=e,this.memoObservers[l].push(u)}),n.forEach(a=>{const u=a.block,f=u.dataset.nodeId;if(!s[f]){s[f]={};const c=document.createElement("div");s[f].node=u,c.style.margin="16px 8px",c.style.position="relative",c.id=`protyle-sidebar-memo-${f}`,c.setAttribute("data-node-id",f),s[f].container=c}const g=document.createElement("div"),b=s[f].container.children.length;g.id=`protyle-sidebar-memo-${f}-${b}`,g.setAttribute("data-node-index",b.toString()),g.style.cssText="padding:8px;margin:8px;border-radius:6px;font-size:80%;box-shadow: rgb(15 15 15 / 10%) 0px 0px 0px 1px, rgb(15 15 15 / 10%) 0px 2px 4px;";const E=a.memo,p=a.totalContent;g.innerHTML=`<div data-content-type="number" style="display:inline-block;">${b+1}</div><div data-content-type="text" style="display:inline-block;font-weight:700;user-select:text;">${p}</div><div data-content-type="memo" style="margin:8px 0 0 0;word-wrap:break-word;user-select:text;">${E}</div>`,s[f].container.insertAdjacentElement("beforeend",g)}),Object.keys(s).forEach(a=>{const u=s[a].container;r.insertAdjacentElement("beforeend",u)}),e.innerHTML=r.innerHTML,this.refreshMemoOffset(t,e,s)}refreshMemoOffset(t,e,o){const i=this.alignCenter;Object.keys(o).reduce((r,s)=>{const l=e.querySelector(`div[data-node-id="${s}"]`),a=t.querySelector(`div[data-node-id="${s}"]`);let u=this.getRelatedTop(t,a);return u+=i?this.getCenterOffset(a,l):0,u-=Math.min(l.offsetTop,u-r.elemOffset),this.logger.info("\u8282\u70B9offset\u521D\u59CB\u5316, detail=>",{mainNode:t,sidebar:e,item:l,block:a,offsetHeight:u,blockOffset:this.getRelatedTop(t,a)}),l.style.top=`${u}px`,{elemOffset:u}},{elemOffset:0});const n=e.children;i&&this.adjustAlign(n.length-1,[n.length-1],n,t)}getBlockNode(t){let e=t;for(;!e.dataset.nodeId;)e=e.parentElement;return e}getCenterOffset(t,e){return t.scrollHeight/2-e.scrollHeight/2}getMainNodeID(t){return t.parentElement.parentElement.getAttribute("data-id")}getMergedMemos(t){const e=[];return t.forEach((o,i)=>{const n=this.getBlockNode(o),r=o.getAttribute("data-inline-memo-content");if(i){const s=e[e.length-1],l=s.originIndexs[s.originIndexs.length-1];if(t[l].nextSibling==o&&n==s.block&&s.memo==r){s.totalContent+=o.textContent,s.originIndexs.push(i);return}}e.push({block:n,totalContent:o.textContent,memo:r,originIndexs:[i]})}),d&&this.logger.info("\u83B7\u5F97\u5408\u5E76memo=>",e),e}getRelatedTop(t,e){return e.getBoundingClientRect().y-t.getBoundingClientRect().y}waitForDataLoading(t,e=!1){return v(this,null,function*(){const o=t.parentElement.dataset.fullwidth;if(d&&this.logger.info(`\u68C0\u6D4B\u5230${o?"\u662F":"\u4E0D\u662F"}\u5168\u5BBD\u6A21\u5F0F`),!o&&!e)return yield B(100);let i=0;const n=Object.assign({},getComputedStyle(t));yield B(50);let r=n.padding!=getComputedStyle(t).padding||n.width!=getComputedStyle(t).width;for(;!r&&(r=n.padding!=getComputedStyle(t).padding||n.width!=getComputedStyle(t).width,yield B(50),i+=1,i!=5););let s={padding:"",width:""};for(r=s.padding==getComputedStyle(t).padding&&s.width==getComputedStyle(t).width;!r&&(s=Object.assign({},getComputedStyle(t)),yield B(100),r=s.padding==getComputedStyle(t).padding&&s.width==getComputedStyle(t).width,i+=1,i!=10););})}}module.exports=F})();
